version: "3"

env:
  CLUSTER_NAME: local
  KIND_CLUSTER_NAME: kind-{{.CLUSTER_NAME}}
  KUBERNETES_VERSION: v1.34.0
  METALLB_VERSION: v0.15.2
  CILIUM_VERSION: v1.17.5
  SHELL: /usr/bin/env bash

tasks:
  use_context:
    desc: Switch kubectl context to the appropriate cluster
    cmds:
      - |
        CURRENT_CONTEXT=$(kubectl config current-context)
        case "$CURRENT_CONTEXT" in
          *minikube*)
            echo "Current context is minikube. No need to change the context."
            ;;
          *k3d*)
            echo "Current context is k3d. No need to change the context."
            ;;
          *{{.KIND_CLUSTER_NAME}}*)
            echo "Current context is already set to kind."
            ;;
          *)
            echo "Setting context to kind."
            kubectl config use-context {{.KIND_CLUSTER_NAME}}
            ;;
        esac
    silent: true

  cluster:create:
    vars:
      PROVIDER: '{{.PROVIDER | default "kind"}}'
    desc: Create a kind cluster and initialize it
    silent: true
    cmds:
      - echo "Creating cluster {{.CLUSTER_NAME}} with Kubernetes version {{.KUBERNETES_VERSION}}"
      - |
        set -ex
        case "{{.PROVIDER}}" in
          kind)
            bash ./scripts/kind-cluster.sh
            bash ./scripts/lb.sh
            ;;
          k3d)
            bash ./scripts/k3d-cluster.sh create
            ;;
          *)
            echo "Invalid provider: {{.PROVIDER}}"
            exit 1
            ;;
        esac
      - task: cluster:init

  cluster:destroy:
    desc: Delete the kind cluster
    vars:
      PROVIDER: '{{.PROVIDER | default "kind"}}'
    cmds:
      - |
        case "{{.PROVIDER}}" in
          kind)
            kind delete cluster -n {{.CLUSTER_NAME}}
            ;;
          k3d)
            bash ./scripts/k3d-cluster.sh delete
            ;;
          *)
            echo "Invalid provider: {{.PROVIDER}}"
            exit 1
            ;;
        esac

  cluster:init:
    desc: Initialize cluster with namespaces and load balancer
    deps: [use_context]
    cmds:
      - echo "Initializing cluster"
      - kubectl create namespace test
      - kubectl create namespace monitoring
      - kubectl create namespace ops
      - task: use_context
      - (kubectl get pods -A | grep cert-manager) || task helm -- cert-manager
      - (kubectl get pods -n kube-system | grep metrics-server) || task helm -- metrics-server

  cilium:
    desc: Install Cilium CNI with Helm
    deps: [use_context]
    cmds:
      - helm repo add cilium https://helm.cilium.io/
      - helm repo update
      - |
        helm install cilium cilium/cilium --version {{.CILIUM_VERSION}} \
          --namespace kube-system \
          --set prometheus.enabled=true --set envoy.enabled=true \
          --set operator.prometheus.enabled=true \
          --set hubble.enabled=true \
          --set hubble.metrics.enableOpenMetrics=true \
          --set hubble.relay.enabled=true \
          --set hubble.ui.enabled=true \
          --set hubble.metrics.enabled="{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}"
      - kubectl -n kube-system delete daemonset kindnet || true
      - kubectl -n kube-system delete daemonset kube-proxy || true

  helm:
    desc: Manage Helm charts using Helmfile
    dir: ./manifest/helm
    deps: [use_context]
    silent: true
    cmds:
      - |
        (command -v helmfile > /dev/null 2>&1) || (echo "helmfile not found. Please install it: https://helmfile.readthedocs.io/en/latest/install/" && exit 1)
        (command -v helm > /dev/null 2>&1) || (echo "helm not found. Please install it: https://helm.sh/docs/intro/install/" && exit 1)
        (command -v yq > /dev/null 2>&1) || (echo "yq not found. Please install it: https://github.com/mikefarah/yq#install" && exit 1)
        (helm plugin list | grep -q "diff") || helm plugin install https://github.com/databus23/helm-diff
        case "{{.CLI_ARGS}}" in
          ls)
            echo -e "\nAvailable charts:" && \
            yq '.releases[].name' helmfile.yaml | sed 's/^/  /'
            ;;
          all)
            echo "Deploying all Helm charts..."
            helmfile apply --skip-diff-on-install
            ;;
          "")
            echo "Usage: task helm -- ls | all | <chart-name>"
            ;;
          *)
            echo "Deploying specific chart: {{.CLI_ARGS}}"
            helmfile apply --selector name={{.CLI_ARGS}} --skip-diff-on-install
            ;;
        esac
